

# 外部 SD 起動によるバックアップやリカバリ #
Glo を最後にお手軽な殻割りや内部 SD 交換ができるデバイスがなくなってしまったため，現状は安易にファームウエアの差し替えがやりづらいことになっている．

だからといって純正のまま使い続けるのもアレなわけなので，差し替え時の事故による文鎮化から復旧する備えを用意することを考える．できれば殻割りナシでできるような備えをね．

イマドキのデバイスでも外部 SD 起動(Touch で言うところのホームボタン押しながら，電源スライドしたままON，Glo だとライトスイッチ押しながら，以下同文)ができるのかは所有していないのでわからないのだけど，できると仮定してしまう．

## 用意するもの ##
  1. 所有しているデバイスのメモリイメージ (注:にわとりたまごの問題あり)
  1. デバイスのスロットに装着できる microSD (内蔵デバイスの容量よりも大きい容量のものが望ましい)
  1. ext4 のファイルシステムを手動でゴニョゴニョできる PC に類するもの
  1. 上記 PC に類するものに microSD を接続するためのリーダー/ライター
  1. それなりの知識

## 手順 ##
### 外部起動用の microSD(とりあえず版) を作成する ###
最初に外部起動用の microSD を作成する．とりあえず版なので，カンタン．
  * 用意したメモリイメージを microSD へ書込み

### 外部 SD 起動が可能か確認する ###
これまでの経験により外部 SD 起動ができない個体があることがわかっているので，それが可能か予め確認しておく．
  * microSD を外部スロットに装着し，外部 SD 起動を試みる
  * 外部 SD 起動が可能か確認する

外部 SD 起動はファクトリーリセット起動と操作が似ているので，誤ってファクトリーリセットになってしまわないように留意する．

この時の microSD の内容は通常の kobo のものと同じなので，nickel が起動するはずである．正常に外部 SD 起動した場合は **FAT32 フォーマットした SD カードを装着しなはれ** という旨のメッセージが表示される．

ここで nickel が起動しない場合はオペミスで外部 SD 起動のシーケンスに入っていないか，uboot が壊れているか，外部 SD 起動できない個体である，などが考えられる．

### 外部起動用の microSD(ホント版) を作成する ###
外部 SD 起動が可能であることを確認したら，次にホント版の外部起動用 microSD を作成する．広く知られている Ethernet over USB による telnet 可能化等々に加え，nickel を動かないようにするだけである．
  * 用意したメモリイメージを microSD へ書込み(作成済みのハズ)
  * FAT32 パーティションのサイズを大きくして(大きくしなくてもできるかもしれない，後述)
  * /etc/init.d/rcS を以下のようにいじる
    * FAT32 パーティションをマウントしないように修正
    * nickel が起動しないように修正
    * /dev/pts を生成，マウントするように修正
    * Ethernet over USB が使えるように insmod を追記
  * /etc/inittab や /etc/inetd.conf を以下のようにいじる
    * telnet か ssh が使えるように修正 (ftp も使えるようにしておくと便利)
  * /usr/local/Kobo/udev/plug を以下のようにいじる
    * Ethernet over USB 時に IP アドレスを設定する
  * その他お好みで必要なツール類の導入
    * おすすめは ddrescue

## 外部 SD 起動でイメージのバックアップ ##
前述の microSD を使って外部 SD 起動することで，
  * 内部 SD は一切マウントされていないフリーな状態で
  * Ethernet over USB を使った telnet アクセスできる

状態になる．

そこで，母艦から telnet アクセスして外部 SD の FAT32 パーティションに内部 SD をダンプする．おおよそ以下の様な感じ．
  * 外部 SD の FAT32 パーティション(/dev/mmcblk1p3)をマウント
  * dd や ddrescue を使用して内部 SD(/dev/mmcblk0) をマウントした FAT32 領域へダンプ
  * お好みで ftp を使い PC にファイル転送する
  * 電源を切る前に FAT32 領域をアンマウント
  * 不慮の事故に備え大事にとっておく

用意した外部 SD の容量が十分に大きく非圧縮でダンプ可能な場合は ddrescue を使用するのが良い．読み出しや書き込みの速度が dd に較べて早く，読み出しに失敗してもリトライなどを勝手にやってくれる．
```
# ddrescue -A /dev/mmcblk0 /(some where)/(image filename)
```

用意した外部 SD の容量が小さく非圧縮でダンプできない場合は，dd を使い gzip 圧縮しながらダンプすれば良い(たぶん 2GB の microSD でもできるんじゃないかな)．ブロックサイズの指定などはお好みで．
```
# dd if=/dev/mmcblk0 | gzip > /(some where)/(image filename).gz
```


(以下，書き中)